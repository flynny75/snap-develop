var FileEditor;
(function(d){function z(){var a=ace.edit("editor").getSession(),b;for(b in t)if(t.hasOwnProperty(b)){var c=t[b];null!=c&&a.removeMarker(c)}t={}}function A(a){var b=ace.edit("editor");b.resize(!0);1<a?b.scrollToLine(a-1,!0,!0,function(){}):b.scrollToLine(0,!0,!0,function(){})}function B(){var a=[],b=1,c;for(c in l)if(l.hasOwnProperty(c)){var h=l[c],k;for(k in h)if(h.hasOwnProperty(k)&&1==h[k]){var f=FileTree.createResourcePath(c),e="\x3cdiv class\x3d'breakpointEnabled'\x3e"+f.projectPath+"\x3c/div\x3e";
a.push({recid:b++,name:e,location:"Line "+k,resource:f.projectPath,line:parseInt(k),script:f.resourcePath})}}w2ui.breakpoints.records=a;w2ui.breakpoints.refresh();Command.updateScriptBreakpoints()}function w(){var a=ace.edit("editor"),b;b=ace.edit("editor").getSession().getUndoManager();var c=jQuery.extend(!0,{},b.$undoStack),h=jQuery.extend(!0,{},b.$redoStack);b={undoStack:c,redoStack:h,dirtyCounter:b.dirtyCounter};a=a.getValue();return{breakpoints:l,resource:g,history:b,source:a}}function F(a){a=
a.toLowerCase();return stringEndsWith(a,".snap")?"ace/mode/snapscript":stringEndsWith(a,".xml")?"ace/mode/xml":stringEndsWith(a,".json")?"ace/mode/json":stringEndsWith(a,".sql")?"ace/mode/sql":stringEndsWith(a,".js")?"ace/mode/javascript":stringEndsWith(a,".html")||stringEndsWith(a,".htm")?"ace/mode/html":stringEndsWith(a,".txt")?"ace/mode/text":stringEndsWith(a,".properties")?"ace/mode/properties":stringEndsWith(a,".gitignore")?"ace/mode/text":stringEndsWith(a,".project")||stringEndsWith(a,".classpath")?
"ace/mode/xml":"ace/mode/text"}function I(a,b){var c=b.toLowerCase(),h=/(function|static|public|private|abstract|override|)\s+([a-z][a-zA-Z0-9]*)\s*\(/g,k=/(var|const)\s+([a-z][a-zA-Z0-9]*)/g,f=/(class|trait|enum)\s+([A-Z][a-zA-Z0-9]*)/g,e=/import\s+([a-z][a-zA-Z0-9\.]*)\.([A-Z][a-zA-Z]*)/g,m={};if(stringEndsWith(c,".snap"))for(var c=a.split(/\r?\n/),d=0;d<c.length;d++){var g=c[d];q(g,d+1,h,m,["%s("],!1);q(g,d+1,k,m,"%s.;%s\x3d;%s \x3d;%s\x3c;%s \x3c;%s\x3e;%s \x3e;%s!;%s !;%s-;%s -;%s+;%s +;%s*;%s *;%s%;%s %;%s/;%s /".split(";"),
!1);q(g,d+1,e,m,"new %s(,%s.,:%s,: %s,extends %s,with %s,extends  %s,with  %s,.%s;, as %s,%s[".split(","),!0);q(g,d+1,f,m,"new %s(,%s.,:%s,: %s,extends %s,with %s,extends  %s,with  %s,.%s;, as %s,%s[".split(","),!1)}r=m;if(null!=x){var l=r[x];null!=l&&(setTimeout(function(){A(l.line)},100),x=null)}}function q(a,b,c,h,k,f){c.lastIndex=0;c=c.exec(a);if(null!=c&&0<c.length){a=c[1];c=c[2];for(var e=0;e<k.length;e++){var d=k[e].replace("%s",c);h[d]=f?{resource:"/"+a.replace(".","/")+".snap",line:b}:{resource:null,
line:b}}}}function G(){ace.edit("editor").getSession().setScrollTop(0)}function H(){return{getCompletions:function(a,b,c,h,d){0===h.length?d(null,[]):(b=a.getValue(),a=a.session.getLine(c.row).substring(0,c.column-h.length),c=JSON.stringify({resource:g.projectPath,line:c.row,complete:a,source:b,prefix:h}),$.ajax({contentType:"application/json",data:c,dataType:"json",success:function(a){a=a.tokens;var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push({name:c,value:c,score:300,meta:a[c]});d(null,b)},error:function(){console.log("Completion control failed")},
processData:!1,type:"POST",url:"/complete/"+document.title}))}}}function J(){y(function(a){var b=H();null!=C&&a.setTheme(C);a.completers=[b];a.getSession().setMode("ace/mode/snapscript");a.getSession().setTabSize(3);a.setReadOnly(!1);a.setAutoScrollEditorIntoView(!0);a.getSession().setUseSoftTabs(!0);a.commands.removeCommand("replace");a.commands.removeCommand("find");a.commands.removeCommand("expandToMatching");a.commands.removeCommand("expandtoline");a.setShowPrintMargin(!1);a.setOptions({enableBasicAutocompletion:!0});
a.on("guttermousedown",function(c){var b=c.domEvent.target;if(-1!=b.className.indexOf("ace_gutter-cell")&&a.isFocused()&&!(c.clientX>25+b.getBoundingClientRect().left)){var d=c.getDocumentPosition().row;if(null!=g){var f=ace.edit("editor").getSession(),b=l[g.filePath],e=f.getBreakpoints(),m=!1,p;for(p in e)if(p==d){m=!0;break}m?f.clearBreakpoint(d):f.setBreakpoint(d);p=parseInt(d);null==b?(b={},b[p+1]=!0,l[g.filePath]=b):b[p+1]=1==b[p+1]?!1:!0}B();c.stop()}});createEditorLinks(a,K,L);KeyBinder.bindKeys();
Project.changeProjectFont();G();LoadSpinner.finish();"undefined"!==typeof java&&a.setScrollSpeed(.05)})}function K(a,b){if(KeyBinder.isControlPressed())for(var c="\\.[A-Z][a-zA-Z0-9]*; \\sas\\s+[A-Z][a-zA-Z0-9]*; [a-zA-Z][a-zA-Z0-9]*\\s*\\. [a-z][a-zA-Z0-9]*\\s*[\x3d|\x3c|\x3e|!|-|+|*|\\/|%] new\\s+[A-Z][a-zA-Z0-9]*\\s*\\( [a-zA-Z][a-zA-Z0-9]*\\s*\\( [A-Z][a-zA-Z0-9]*\\s*\\[ :\\s*[A-Z][a-zA-Z0-9]* extends\\s+[A-Z][a-zA-Z0-9]* with\\s+[A-Z][a-zA-Z0-9]*".split(" "),h=0;h<c.length;h++){var d=new RegExp(c[h],
"g"),f=null;d.lastIndex=0;a.replace(d,function(a){var c=arguments[arguments.length-2],d=a.length;c<=b&&c+d>=b&&null!=r[a]&&(f={start:c,value:a})});if(null!=f)return f}return null}function L(a){if(KeyBinder.isControlPressed()){var b=r[a.value];null!=b&&(null!=b.resource?(x=a.value,window.location.hash=b.resource):A(b.line))}}function y(a){(function(){if(null!=document.getElementById("editor")){ace.require("ace/ext/language_tools");var b=ace.edit("editor");if(null!=b)return a(b),!0}return!1})()||setTimeout(function(){y(a)},
100)}var l={},t={},g=null,D=null,C=null,r={},x=null,E={};d.createEditor=function(){window.setTimeout(J,400);EventBus.createTermination(z)};d.clearEditorHighlights=z;d.showEditorLine=A;d.createEditorHighlight=function(a,b){var c=ace.edit("editor"),d=ace.require("ace/range").Range,c=c.getSession();z();d=c.addMarker(new d(a-1,0,a-1,1),b,"fullLine");t[a]=d};d.findAndReplaceTextInEditor=function(){var a=w();Command.searchAndReplaceFiles(a.resource.projectPath)};d.findTextInEditor=function(){var a=w();
Command.searchFiles(a.resource.projectPath)};d.addEditorKeyBinding=function(a,b){ace.edit("editor").commands.addCommand({name:a.editor,bindKey:{win:a.editor,mac:a.editor},exec:function(a){b&&b()}})};d.showEditorBreakpoints=B;d.resizeEditor=function(){var a=ace.edit("editor"),b=document.getElementById("editor").offsetWidth,c=document.getElementById("editor").offsetHeight;console.log("Resize editor "+b+"x"+c);a.setAutoScrollEditorIntoView(!0);a.resize(!0)};d.resetEditor=function(){var a=ace.edit("editor"),
b=a.getSession();t={};g=null;a.setReadOnly(!1);b.setValue(D,1);$("#currentFile").html("")};d.loadEditor=w;d.resolveEditorMode=F;d.updateEditor=function(a,b){var c=ace.edit("editor"),d=c.getSession(),k=d.getMode(),f=F(b);a:{var e=a;if(e){var m=b.toLowerCase();if(stringEndsWith(m,".json"))try{var p=JSON.parse(e);a=JSON.stringify(p,null,3);break a}catch(M){}a=e}else a=""}e=w();e.resource&&e.source&&(m=md5(e.source),E[e.resource.resourcePath]={hash:m,history:e.history});f!=k&&d.setMode({path:f,v:Date.now()});
c.setReadOnly(!1);c.setValue(a,1);e=a;c=new ace.UndoManager;if(e&&b&&(f=FileTree.createResourcePath(b),k=E[f.resourcePath]))if(e=md5(e),k.hash==e){var f=k.history.undoStack,e=k.history.redoStack,n;for(n in f)f.hasOwnProperty(n)&&(c.$undoStack[n]=f[n]);for(var q in e)e.hasOwnProperty(q)&&(c.$redoStack[q]=f[q]);c.$doc=d;c.dirtyCounter=k.history.dirtyCounter}else E[f.resourcePath]=null;d.setUndoManager(c);var d=ace.edit("editor").getSession(),u;for(u in d.$backMarkers)d.removeMarker(u);u=d.getBreakpoints();
for(var v in u)d.clearBreakpoint(v);$("#currentFile").html("");G();g=FileTree.createResourcePath(b);t={};D=a;window.location.hash=g.projectPath;ProblemManager.highlightProblems();if(null!=b&&(v=l[g.filePath],null!=v))for(var r in v)v.hasOwnProperty(r)&&1==v[r]&&(n=r-1,null!=g&&(u=ace.edit("editor").getSession(),d=l[g.filePath],n=parseInt(n),u.setBreakpoint(n),null==d&&(d={},l[g.filePath]=d),d[n+1]=!0),B());I(a,b);Project.createEditorTab();History.showFileHistory();StatusPanel.showActiveFile(g.projectPath)};
d.showEditorFileInTree=function(){var a=w().resource;FileTree.showTreeNode("explorerTree",a)};d.getSelectedText=function(){return ace.edit("editor").getSelectedText()};d.isEditorChanged=function(){return null!=g?ace.edit("editor").getValue()!=D:!1};d.formatEditorSource=function(){var a=ace.edit("editor"),b=a.getValue();$.ajax({contentType:"text/plain",data:b,success:function(b){a.setReadOnly(!1);a.setValue(b,1)},error:function(){console.log("Format failed")},processData:!1,type:"POST",url:"/format/"+
document.title})};d.setEditorTheme=function(a){y(function(b){null!=a&&(b=ace.edit("editor"),null!=b&&b.setTheme(a),C=a)})};d.updateEditorFont=function(a,b){y(function(c){var d=H();c.completers=[d];c.setOptions({enableBasicAutocompletion:!0,fontFamily:"'"+a+"',monospace",fontSize:b})})}})(FileEditor||(FileEditor={}));ModuleSystem.registerModule("editor","Editor module: editor.js",null,FileEditor.createEditor,["common","spinner","tree"]);
